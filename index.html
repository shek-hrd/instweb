<?php
// PHP is used here only to serve the initial page and nothing else.
// The core application logic is in JavaScript.
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test a Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        .editor-section, .log-section { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .editor-container { position: relative; height: 400px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .CodeMirror { height: 100%; }
        iframe { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 4px; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #log-area, #history-area { height: 150px; overflow-y: auto; background: #333; color: #fff; padding: 10px; border-radius: 4px; }
        .footer { text-align: center; margin-top: 20px; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test a Web</h1>
        <div class="editor-section">
            <h2>Editor & Preview</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <div class="editor-container">
                        <textarea id="codeEditor"></textarea>
                    </div>
                    <div class="controls">
                        <button id="publishBtn">üöÄ Publish</button>
                        <button id="downloadBtn">‚¨áÔ∏è Download</button>
                        <button id="copyCodeBtn">üìã Copy Code</button>
                    </div>
                </div>
                <div style="flex: 1;">
                    <iframe id="previewFrame"></iframe>
                </div>
            </div>
        </div>
        
        <div class="log-section">
            <h2>History & Log</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Shell Log</h3>
                    <pre id="log-area"></pre>
                </div>
                <div style="flex: 1;">
                    <h3>History</h3>
                    <pre id="history-area"></pre>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>created by <a href="mailto:shekhrd+code@gmail.com">shekhrd</a> | Donations: <a href="https://etherscan.io/address/0x6f602be9fccf656c8c3e9f36d2064d580264b393">0x6f602be9fccf656c8c3e9f36d2064d580264b393</a></p>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const previewFrame = document.getElementById('previewFrame');
            const publishBtn = document.getElementById('publishBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const logArea = document.getElementById('log-area');
            const historyArea = document.getElementById('history-area');
            const initialCode = "<h1>Hello, World!</h1>\n<p>Start typing or drop a file here.</p>";
            let githubToken = localStorage.getItem('githubToken');

            // Initialize CodeMirror editor
            const codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                lineNumbers: true,
                mode: "xml",
                htmlMode: true
            });
            codeEditor.setValue(initialCode);
            codeEditor.on('change', () => {
                updatePreview();
            });

            function updatePreview() {
                const code = codeEditor.getValue();
                previewFrame.srcdoc = code;
            }

            // Initial preview update
            updatePreview();

            // Event listener for drag-and-drop
            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        codeEditor.setValue(event.target.result);
                        updateLog('File uploaded and loaded into editor.');
                        updateHistory('File upload');
                    };
                    reader.readAsText(file);
                }
            });

            // Handle the publish button click
            publishBtn.addEventListener('click', async () => {
                if (!githubToken) {
                    githubToken = prompt("Please enter your GitHub Personal Access Token (PAT):");
                    if (githubToken) {
                        localStorage.setItem('githubToken', githubToken);
                    } else {
                        updateLog("Publishing aborted: GitHub token not provided.");
                        return;
                    }
                }

                const code = codeEditor.getValue();
                const filename = `index-${Date.now()}.html`;
                const owner = 'your-github-username'; // CHANGE THIS TO YOUR GITHUB USERNAME
                const repo = 'instweb';
                const message = `feat: create new web app - ${filename}`;
                const content = btoa(code); // Base64 encode the content

                try {
                    updateLog(`Committing file '${filename}' to GitHub repository...`);
                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filename}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            content: content,
                            branch: 'main'
                        })
                    });

                    if (response.ok) {
                        updateLog(`Successfully committed file to GitHub. Deployment in progress...`);
                        updateHistory(`Published to GitHub: ${filename}`);

                        // Optional: For teardown logic, we need to log the URL in the repo
                        // This step would require a separate API call to update a log file.
                        // For simplicity, the GitHub Actions teardown script will scan the repo for new files.

                        // Open the URL after a small delay
                        const repoUrl = `https://${owner}.github.io/${repo}`; // Surge URL is handled by the GitHub Action
                        // This is a placeholder as the exact URL is generated by the GitHub Action
                        // We can't know the full URL from the client side unless the API provides it.
                        // The GitHub Action will output the URL which you can check manually.
                        alert("Deployment triggered! Your site will be live soon on a Surge subdomain. Check your GitHub Actions tab for the URL.");
                    } else {
                        const error = await response.json();
                        updateLog(`Error: Could not commit to GitHub. Status: ${response.status}. Message: ${error.message}`);
                        updateHistory('GitHub API Error');
                    }
                } catch (error) {
                    updateLog(`Network error: ${error.message}`);
                    updateHistory('Network Error');
                }
            });

            // Handle file download
            downloadBtn.addEventListener('click', () => {
                const code = codeEditor.getValue();
                const blob = new Blob([code], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'index.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                updateLog('Code downloaded as index.html');
                updateHistory('Code download');
            });

            // Handle copy to clipboard
            copyCodeBtn.addEventListener('click', () => {
                const code = codeEditor.getValue();
                navigator.clipboard.writeText(code).then(() => {
                    updateLog('Code copied to clipboard.');
                    updateHistory('Code copied');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });

            // Functions for log and history
            function updateLog(message) {
                const now = new Date().toLocaleTimeString();
                logArea.textContent += `[${now}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }

            function updateHistory(action) {
                const now = new Date().toLocaleTimeString();
                historyArea.textContent += `[${now}] ${action}\n`;
                historyArea.scrollTop = historyArea.scrollHeight;
            }
        });
    </script>
</body>
</html>