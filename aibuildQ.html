<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Web App Builder</title>
    <style>
        /* Modern, sleek styling - Condensed */
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --gray: #6c757d;
            --border-radius: 6px; /* Slightly reduced */
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Slightly reduced */
            --font-size-sm: 0.85rem; /* Added smaller font size */
            --font-size-xs: 0.75rem; /* Added extra small font size */
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 15px; /* Reduced padding */
            font-size: var(--font-size-sm); /* Apply smaller base font */
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 30px); /* Account for body padding */
            display: flex;
            flex-direction: column;
        }
        header {
            text-align: center;
            padding: 10px 0; /* Reduced padding */
            margin-bottom: 15px; /* Reduced margin */
        }
        h1 {
            color: var(--secondary);
            margin-bottom: 5px; /* Reduced margin */
            font-size: 1.8rem; /* Reduced font size */
        }
        .subtitle {
            color: var(--gray);
            font-size: var(--font-size-sm); /* Use smaller font */
        }
        .main-content {
            display: flex;
            gap: 15px; /* Reduced gap */
            flex: 1;
            min-height: 0; /* Crucial for flexbox scrolling */
        }
        .panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px; /* Reduced padding */
            display: flex;
            flex-direction: column;
        }
        .input-section {
            flex: 1;
            min-width: 300px;
            max-width: 400px; /* Optional: limit max width */
        }
        .preview-section {
            flex: 2; /* Takes more space */
            display: flex;
            flex-direction: column;
        }
        .panel-title {
            font-size: 1.2rem; /* Reduced font size */
            margin-bottom: 12px; /* Reduced margin */
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
        }

        /* Input Section Styles */
        .input-section .panel-title {
             margin-top: 0; /* Ensure title is flush top */
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Reduced gap */
            margin-bottom: 12px; /* Reduced margin */
        }
        .control-group {
            flex: 1;
            min-width: 150px; /* Reduced min-width */
        }
        label {
            display: block;
            margin-bottom: 4px; /* Reduced margin */
            font-weight: 600;
            color: var(--dark);
            font-size: var(--font-size-sm); /* Smaller label font */
        }
        textarea, select {
            width: 100%;
            padding: 8px; /* Reduced padding */
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: var(--font-size-sm); /* Smaller font */
        }
        textarea {
            height: 100px; /* Reduced height */
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px; /* Reduced padding */
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size-sm); /* Smaller font */
            font-weight: 600;
            transition: all 0.2s ease; /* Faster transition */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* Reduced gap */
        }
        button:hover {
            background: var(--secondary);
            transform: translateY(-1px); /* Reduced transform */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Reduced shadow */
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: var(--gray);
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .clear-btn {
            font-size: var(--font-size-xs); /* Extra small font */
            padding: 5px 10px; /* Reduced padding */
            margin-left: auto; /* Push to the right */
        }

        /* Preview Section Styles */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #previewFrame {
            flex: 1;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background: white;
            min-height: 0; /* Allow shrinking */
        }
        .log-section {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0; /* Allow shrinking */
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Reduced margin */
        }
        #logContainer {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 8px; /* Reduced padding */
            font-family: monospace;
            font-size: var(--font-size-xs); /* Very small font for logs */
        }
        .log-entry {
            padding: 6px; /* Reduced padding */
            margin-bottom: 6px; /* Reduced margin */
            border-radius: var(--border-radius);
            background: #ffffff;
            border-left: 3px solid var(--accent);
            overflow-x: auto;
        }
        .log-entry.prompt {
            border-left-color: var(--primary);
            background: #eef5ff;
        }
        .log-entry.response {
            border-left-color: var(--success);
            background: #f0fff4;
        }
        .log-entry.error {
            border-left-color: var(--danger);
            background: #ffebee;
        }
        .log-entry.debug {
            border-left-color: var(--warning);
            background: #fff8e1;
            font-size: var(--font-size-xs); /* Smaller debug text */
        }
        .log-entry.debug summary {
             cursor: pointer;
             font-weight: bold;
             margin-bottom: 4px;
        }
        .log-entry.debug details {
             margin-left: 10px;
        }

        /* Status & Info Styles */
        .status-container {
            margin-top: auto; /* Push to bottom */
            padding: 10px; /* Reduced padding */
            border-radius: var(--border-radius);
            background: #e9f7fe;
            border-left: 3px solid var(--accent); /* Thinner border */
            font-size: var(--font-size-sm); /* Smaller font */
        }
        .status-message {
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced gap */
        }
        .spinner {
            width: 16px; /* Smaller spinner */
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            height: 3px; /* Thinner bar */
            background: #e0e0e0;
            border-radius: 1.5px; /* Adjusted border radius */
            margin: 8px 0; /* Reduced margin */
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }
        .model-info {
            background: #f0f8ff;
            padding: 8px; /* Reduced padding */
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-size: var(--font-size-xs); /* Extra small font */
        }
        .model-info h4 {
            margin-bottom: 4px; /* Reduced margin */
            color: var(--secondary);
            font-size: var(--font-size-sm); /* Smaller heading */
        }
        .model-info p {
            margin: 2px 0; /* Reduced margin */
            color: var(--gray);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .controls {
                flex-direction: column;
            }
            .input-section {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Web App Builder</h1>
            <p class="subtitle">Describe your app and generate it with Claude AI models</p>
        </header>
        <div class="main-content">
            <!-- Input Panel -->
            <div class="panel input-section">
                <h2 class="panel-title">Create Your App</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="appDescription">App Description</label>
                        <textarea id="appDescription" placeholder="Describe what kind of web application you want to create..."></textarea>
                    </div>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label for="modelSelect">AI Model</label>
                        <select id="modelSelect">
                            <option value="claude-sonnet-4">Claude Sonnet 4 (Balanced)</option>
                            <option value="claude-opus-4">Claude Opus 4 (Most Intelligent)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="examples">Quick Examples</label>
                        <select id="examples">
                            <option value="">Select an example...</option>
                            <option value="A simple calculator with basic operations">Calculator</option>
                            <option value="A weather forecast app showing current conditions and 5-day forecast">Weather App</option>
                            <option value="A to-do list with add, delete, and mark complete functionality">Todo List</option>
                            <option value="A simple note-taking app with local storage">Note Taking</option>
                        </select>
                    </div>
                </div>
                <div class="controls">
                    <button id="generateBtn">
                        <span>Generate App</span>
                    </button>
                </div>
                <div class="model-info">
                    <h4>Model Information</h4>
                    <p><strong>Sonnet 4:</strong> Balanced</p>
                    <p><strong>Opus 4:</strong> Most intelligent</p>
                </div>
                <div class="status-container">
                    <div class="status-message">
                        <span id="statusText">Ready to generate your app</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                 <button id="clearLogBtn" class="btn-secondary clear-btn">
                    Clear Log
                </button>
            </div>
            <!-- Preview Panel -->
            <div class="panel preview-section">
                 <div class="preview-header">
                    <h2 class="panel-title">Preview</h2>
                 </div>
                <iframe id="previewFrame" title="Generated App Preview"></iframe>
                <div class="log-section">
                    <div class="log-header">
                        <h3>Generation Log</h3>
                    </div>
                    <div id="logContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Include Puter.js library -->
    <script src="https://js.puter.com/v2/"></script>
    <script>
        // DOM Elements
        const appDescriptionInput = document.getElementById('appDescription');
        const generateBtn = document.getElementById('generateBtn');
        const previewFrame = document.getElementById('previewFrame');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const modelSelect = document.getElementById('modelSelect');
        const examplesSelect = document.getElementById('examples');
        const logContainer = document.getElementById('logContainer');
        const clearLogBtn = document.getElementById('clearLogBtn');
        // Initialize logging array
        let logEntries = [];
        // Function to update the status message
        function updateStatus(message, isLoading = false) {
            if (isLoading) {
                statusText.innerHTML = `<span class="spinner"></span> ${message}`;
            } else {
                statusText.textContent = message; // Use textContent to prevent HTML injection
            }
        }
        // Function to update progress bar
        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }
        // Function to add entry to log
        function addToLog(type, content) {
            const timestamp = new Date().toISOString();
            // Sanitize content to prevent HTML rendering issues in logs
            const sanitizedContent = content
                .replace(/&/g, "&amp;")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            const entry = {
                timestamp,
                type,
                content: sanitizedContent
            };
            logEntries.push(entry);
            renderLog();
        }
        // Function to add detailed debug entry to log
        function addDebugLog(label, data) {
             const timestamp = new Date().toISOString();
             const timeString = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
             const entryElement = document.createElement('div');
             entryElement.className = `log-entry debug`;
             // Safely convert data to string for display
             let dataString = "N/A";
             if (data !== null && data !== undefined) {
                 if (typeof data === 'object') {
                     try {
                         dataString = JSON.stringify(data, null, 2); // Pretty print JSON
                     } catch (e) {
                         dataString = String(data); // Fallback if JSON stringify fails
                     }
                 } else {
                     dataString = String(data);
                 }
             }
             const escapedDataString = dataString
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");

             entryElement.innerHTML = `
                 <strong>${timeString} [DEBUG]:</strong>
                 <details>
                     <summary>${label}</summary>
                     <pre>${escapedDataString}</pre>
                 </details>
             `;
             logContainer.appendChild(entryElement);
             logContainer.scrollTop = logContainer.scrollHeight;
             // Keep log size manageable
             const allEntries = logContainer.querySelectorAll('.log-entry');
             if (allEntries.length > 50) {
                 allEntries[0].remove();
             }
        }
        // Function to render log entries (for standard entries)
        function renderLog() {
            // This function now only handles standard log entries added via addToLog
            // Debug logs are added directly to the DOM by addDebugLog
            // We still need this to manage the list of standard entries and scrolling
            // But we don't rebuild the entire log container anymore.

            // Scroll to bottom after standard entries are added
            logContainer.scrollTop = logContainer.scrollHeight;
            // Keep log size manageable for standard entries too
            const standardEntries = logContainer.querySelectorAll('.log-entry:not(.debug)');
            if (standardEntries.length > 50) {
                 // Remove the oldest standard entry if we exceed 50
                 // Find the first non-debug entry
                 let firstStandardEntry = null;
                 for (let i = 0; i < logContainer.children.length; i++) {
                     if (!logContainer.children[i].classList.contains('debug')) {
                         firstStandardEntry = logContainer.children[i];
                         break;
                     }
                 }
                 if (firstStandardEntry) {
                     firstStandardEntry.remove();
                 }
            }
        }
        // Function to clear log
        function clearLog() {
            logEntries = [];
            logContainer.innerHTML = ''; // Clear all DOM elements
        }
        // Function to generate the HTML code for the app
        async function generateAppCode(description, model) {
            addToLog('prompt', `Generating app with ${model}: ${description}`);
            const prompt = `
                Generate a complete, self-contained HTML file for a web application based on this description: "${description}".
                The output should be valid HTML code only, including embedded CSS and JavaScript if needed.
                Do not include any explanations, markdown formatting (like \`\`\`html), or extra text. Just the raw HTML code.
                Make sure it's a single HTML file that works when opened directly in a browser.
                The application should be visually appealing and functional.
                Ensure the generated code uses modern web standards.
                Please make the generated code as robust and clean as possible.
                The final code should be optimized for performance and user experience.
            `;
            // Declare interval variable in a scope accessible to try/catch/finally
            let interval = null;
            try {
                updateProgress(0);
                updateStatus('Initializing AI...', true);
                let progress = 0;
                // Assign the interval ID to the variable
                interval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90; // Cap progress until response
                    updateProgress(progress);
                }, 200);

                // --- Debugging: Log the request ---
                addDebugLog("AI Request (Prompt)", prompt);
                addDebugLog("AI Request (Options)", { model: model });

                const response = await puter.ai.chat(prompt, { model: model });

                // --- Debugging: Log the raw response ---
                addDebugLog("AI Raw Response", response);

                // Clear the interval if the request is successful
                if (interval) {
                    clearInterval(interval);
                    interval = null; // Good practice to nullify after clearing
                }
                updateProgress(100);

                if (response && response.message && response.message.content && Array.isArray(response.message.content)) {
                    const content = response.message.content[0];
                    if (content && typeof content.text === 'string') {
                        // Crucial: Sanitize the AI output to remove potential markdown wrappers
                        let htmlCode = content.text.trim();
                        // Remove potential leading/trailing markdown code block indicators
                        if (htmlCode.startsWith("```html")) {
                            htmlCode = htmlCode.substring(7).trim(); // Remove ```html
                        }
                        if (htmlCode.startsWith("```")) {
                            htmlCode = htmlCode.substring(3).trim(); // Remove potential remaining ```
                        }
                        if (htmlCode.endsWith("```")) {
                            htmlCode = htmlCode.slice(0, -3).trim(); // Remove trailing ```
                        }
                        addToLog('response', `Generated ${htmlCode.length} characters of HTML`);
                        return htmlCode; // Return the cleaned HTML
                    } else {
                        throw new Error('Unexpected response format from AI: Missing text content');
                    }
                } else {
                    throw new Error('Unexpected response format from AI');
                }
            } catch (error) {
                // Clear the interval if an error occurs
                if (interval) {
                    clearInterval(interval);
                    interval = null; // Good practice to nullify after clearing
                }
                updateProgress(0);
                console.error('Error generating app:', error);

                // --- Debugging: Log the caught error ---
                addDebugLog("AI Error Caught", error);

                // Robust error handling: Check if error and error.message exist
                let errorMsg = 'An unknown error occurred.';
                if (error) {
                    if (typeof error === 'string') {
                        errorMsg = error;
                    } else if (error.message && typeof error.message === 'string') {
                        errorMsg = error.message;
                    } else if (error.toString && typeof error.toString === 'function') {
                        errorMsg = error.toString();
                    } else {
                        errorMsg = JSON.stringify(error); // Fallback for unusual error objects
                    }
                }

                // More robust checks for specific error types
                if (error && error.code === 'error_400_from_delegate' && error.delegate === 'usage-limited-chat') {
                    errorMsg = 'Usage limit reached. Please wait.';
                    addToLog('error', errorMsg);
                    throw new Error(errorMsg);
                } else if (error && error.message && typeof error.message === 'string' && error.message.includes('Permission denied')) {
                    errorMsg = 'Access denied. Please refresh.';
                    addToLog('error', errorMsg);
                    throw new Error(errorMsg);
                } else {
                    // Use the robustly determined errorMsg
                    addToLog('error', `Failed: ${errorMsg}`);
                    throw new Error(errorMsg); // Re-throw the robust error message
                }
            }
            // Ensure interval is cleared if the function exits unexpectedly (though unlikely with async/await)
            finally {
                 if (interval) {
                    clearInterval(interval);
                    interval = null;
                 }
            }
        }
        // Function to load the generated HTML into the iframe
        function loadPreview(htmlContent) {
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            previewFrame.src = url;
            addToLog('response', 'Preview loaded');
        }
        // Event listener for the generate button
        generateBtn.addEventListener('click', async () => {
            const description = appDescriptionInput.value.trim();
            const model = modelSelect.value;
            if (!description) {
                updateStatus('Please enter a description.', false);
                addToLog('error', 'No description provided');
                return;
            }
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner"></span> Generating...';
            try {
                const htmlCode = await generateAppCode(description, model);
                loadPreview(htmlCode);
                updateStatus('App generated successfully!', false);
            } catch (error) {
                // Robustly display the error message
                let displayMsg = 'An unknown error occurred.';
                if (error && typeof error === 'string') {
                    displayMsg = error;
                } else if (error && error.message && typeof error.message === 'string') {
                    displayMsg = error.message;
                } else if (error && error.toString && typeof error.toString === 'function') {
                    displayMsg = error.toString();
                }
                updateStatus(`Error: ${displayMsg}`, false);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>Generate App</span>';
            }
        });
        // Event listener for example selection
        examplesSelect.addEventListener('change', () => {
            const selectedExample = examplesSelect.value;
            if (selectedExample) {
                appDescriptionInput.value = selectedExample;
                examplesSelect.value = '';
            }
        });
        // Event listener for clear log button
        clearLogBtn.addEventListener('click', clearLog);
        // Optional: Generate an example app on page load
        window.addEventListener('load', () => {
            appDescriptionInput.value = "A simple todo list app with add, delete, and mark complete functionality.";
            addToLog('prompt', 'Page loaded - ready to generate apps');
 